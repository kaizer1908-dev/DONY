<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget | ê¸ˆìœµì„ ì‡ë‹¤</title>

    <!-- Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Premium Dark Theme Palette */
            --bg-deep: #0f172a;
            --bg-card: #1e293b;
            --primary: #8b5cf6;
            /* Violet */
            --secondary: #3b82f6;
            /* Blue */
            --accent: #10b981;
            /* Emerald */
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --gradient-main: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --modal-bg: rgba(15, 23, 42, 0.95);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow-x: hidden;
        }

        /* Glassmorphism Header */
        header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding: 1rem 0;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .highlight-text {
            background: var(--gradient-main);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        button.btn-reset {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-sub);
            border: var(--glass-border);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        button.btn-reset:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }

        /* Container Transitions */
        .view-section {
            width: 100%;
            max-width: 1000px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease-out;
            display: none;
            /* Hidden by default */
        }

        .view-section.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        /* Upload Zone */
        .upload-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 4rem 2rem;
            text-align: center;
            border: 2px dashed rgba(139, 92, 246, 0.3);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .upload-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .upload-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(139, 92, 246, 0.1), transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .upload-card:hover::before {
            opacity: 1;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            display: block;
            filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.5));
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 2rem;
            border: var(--glass-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            color: var(--text-sub);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--bg-card);
            width: 90%;
            max-width: 800px;
            border-radius: 24px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.open .modal-content {
            transform: scale(1);
        }

        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }

        .mapping-table th,
        .mapping-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-sub);
        }

        .mapping-table th {
            color: var(--text-main);
            font-weight: 600;
        }

        .select-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            border-radius: 12px;
        }

        .select-item label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-main);
            font-weight: 500;
        }

        select {
            background: var(--bg-deep);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5rem 2rem 0.5rem 1rem;
            border-radius: 8px;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7rem top 50%;
            background-size: .65rem auto;
            width: 150px;
        }

        button.btn-primary {
            background: var(--gradient-main);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button.btn-primary:hover {
            opacity: 0.9;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <h1>Smart<span class="highlight-text">Budget</span></h1>
        <button id="reset-btn" class="btn-reset" onclick="resetApp()">ì´ˆê¸°í™”</button>
    </header>

    <!-- 1. Upload Section -->
    <div id="upload-section" class="view-section active">
        <div class="upload-card" onclick="document.getElementById('file-input').click()" id="drop-zone">
            <span class="upload-icon">ğŸ“‚</span>
            <h2 style="margin-bottom: 1rem;">ê°€ê³„ë¶€ ì—‘ì…€ ì—…ë¡œë“œ</h2>
            <p style="color: var(--text-sub);">
                ì—¬ëŸ¬ ê°œì˜ íŒŒì¼ì„ í•œ ë²ˆì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                ì€í–‰/ì¹´ë“œì‚¬ ì–‘ì‹ ìƒê´€ì—†ì´ ëª¨ë‘ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.
            </p>
            <input type="file" id="file-input" multiple accept=".xlsx, .xls, .csv">
        </div>
    </div>

    <!-- 2. Dashboard Section -->
    <div id="dashboard-section" class="view-section">
        <div class="dashboard-grid">
            <!-- Total Spend -->
            <div class="card">
                <p class="stat-label">ì´ë²ˆ ë‹¬ ì´ ì§€ì¶œ</p>
                <div class="stat-value" id="total-spend-display">0</div>
                <p style="color: var(--accent); font-size: 0.9rem; margin-top: 0.5rem;">
                    ğŸ’¸ ë˜‘ë˜‘í•œ ì†Œë¹„ ìŠµê´€ì„ ë§Œë“¤ì–´ê°€ê³  ê³„ì‹œë„¤ìš”!
                </p>
            </div>

            <!-- Advice -->
            <div class="card">
                <p class="stat-label">ì§€ì¶œ ë¶„ì„</p>
                <div style="margin-top: 0.5rem; line-height: 1.6; color: var(--text-sub);" id="insight-text">
                    ë°ì´í„° ë¶„ì„ ì¤‘...
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 2rem;">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ í˜„í™©</h3>
            <div style="height: 400px; position: relative;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modal for Column Mapping -->
    <div id="mapping-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom: 1rem;">ì—´(Column) ì„ íƒí•˜ê¸°</h2>
            <p style="color: var(--text-sub); margin-bottom: 2rem;">
                ì—…ë¡œë“œí•˜ì‹  íŒŒì¼ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê¸° ìœ„í•´,<br>
                ì–´ë–¤ ì—´ì´ ë‚ ì§œ, ë‚´ìš©, ê¸ˆì•¡ì¸ì§€ ì•Œë ¤ì£¼ì„¸ìš”.
            </p>

            <!-- Preview Table -->
            <div style="overflow-x: auto;">
                <table class="mapping-table" id="preview-table">
                    <!-- Javascript will populate this -->
                </table>
            </div>

            <!-- Selectors -->
            <div class="select-group">
                <div class="select-item">
                    <label>ğŸ“… ë‚ ì§œ</label>
                    <select id="col-date"></select>
                </div>
                <div class="select-item">
                    <label>ğŸ“ ì‚¬ìš©ì²˜/ë‚´ìš©</label>
                    <select id="col-desc"></select>
                </div>
                <div class="select-item">
                    <label>ğŸ’° ê¸ˆì•¡</label>
                    <select id="col-amount"></select>
                </div>
            </div>

            <button class="btn-primary" onclick="confirmMapping()">ë¶„ì„ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <script>
        // State
        let rawData = []; // Raw Excel Data (Array of Arrays)
        let processedData = []; // Finalized Data

        // DOM Elements
        const uploadSection = document.getElementById('upload-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const modal = document.getElementById('mapping-modal');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');

        // --- Initialization ---
        window.addEventListener('load', () => {
            const savedData = localStorage.getItem('budgetData');
            if (savedData) {
                processedData = JSON.parse(savedData);
                showDashboard();
            }
        });

        function resetApp() {
            if (confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('budgetData');
                location.reload();
            }
        }

        // --- File Handling ---

        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = 'rgba(139, 92, 246, 0.3)'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'rgba(139, 92, 246, 0.3)';
            if (e.dataTransfer.files.length) processFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) processFiles(e.target.files);
        });

        async function processFiles(fileList) {
            // Read all files and merge raw data
            const promises = Array.from(fileList).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        resolve(json);
                    };
                    reader.readAsArrayBuffer(file);
                });
            });

            const results = await Promise.all(promises);
            // Merge all rows, but we need to handle headers carefully.
            // For logic simplicy: We take the specific "structure" from the FIRST file 
            // and assume all uploaded files have same structure (common use case).
            // We concatenate the rest.

            // Actually, best user experience: Just take the first valid file's structure to ask for Mapping.
            // Then apply that index-mapping to ALL rows from ALL files.

            rawData = results.flat();
            // Note: results.flat() might mix headers if multiple files are merged. 
            // Advanced: filter out header-like rows later. For now, we trust the mapping Modal.

            showMappingModal(results[0]); // Show preview using first file's content
        }

        // --- Modal & Mapping ---

        function showMappingModal(sampleData) {
            // sampleData is Array of Arrays.
            // Find the "Header" row - heuristic: Row with most strings
            const previewTable = document.getElementById('preview-table');
            const colDate = document.getElementById('col-date');
            const colDesc = document.getElementById('col-desc');
            const colAmount = document.getElementById('col-amount');

            // Clear previous
            previewTable.innerHTML = '';
            colDate.innerHTML = ''; colDesc.innerHTML = ''; colAmount.innerHTML = '';

            // Render Preview (Max 5 rows) using the FIRST non-empty row as header candidate
            // Let's just show top 5 rows raw.
            const limit = Math.min(sampleData.length, 5);
            let headerRowIndex = 0; // Default to first row

            // Generate Options for Select
            const headerRow = sampleData[0];
            headerRow.forEach((cell, idx) => {
                const opt1 = new Option(`${idx}: ${cell}`, idx);
                const opt2 = new Option(`${idx}: ${cell}`, idx);
                const opt3 = new Option(`${idx}: ${cell}`, idx);
                colDate.add(opt1);
                colDesc.add(opt2);
                colAmount.add(opt3);
            });

            // Smart Preset (Guessing)
            headerRow.forEach((cell, idx) => {
                if (typeof cell === 'string') {
                    if (cell.includes('ì¼ì‹œ') || cell.includes('ë‚ ì§œ') || cell.includes('Date')) colDate.value = idx;
                    if (cell.includes('ë‚´ìš©') || cell.includes('ëª…') || cell.includes('ê°€ë§¹ì ')) colDesc.value = idx;
                    if (cell.includes('ê¸ˆì•¡') || cell.includes('ì¶œê¸ˆ') || cell.includes('ì§€ì¶œ')) colAmount.value = idx;
                }
            });

            // Render Table Header & Rows
            let html = `<thead><tr>`;
            headerRow.forEach(cell => html += `<th>${cell}</th>`);
            html += `</tr></thead><tbody>`;

            for (let i = 1; i < limit; i++) {
                html += `<tr>`;
                sampleData[i].forEach(cell => html += `<td>${cell || ''}</td>`);
                html += `</tr>`;
            }
            html += `</tbody>`;
            previewTable.innerHTML = html;

            modal.classList.add('open');
        }

        function confirmMapping() {
            const dateIdx = parseInt(document.getElementById('col-date').value);
            const descIdx = parseInt(document.getElementById('col-desc').value);
            const amtIdx = parseInt(document.getElementById('col-amount').value);

            // Process Data
            const CATEGORY_KEYWORDS = {
                'ì‹ë¹„': ['ì‹ë‹¹', 'ë°¥', 'ì¹´í˜', 'ì»¤í”¼', 'í¸ì˜ì ', 'ë§ˆíŠ¸', 'í‘¸ë“œ', 'ì¿ íŒ¡ì´ì¸ ', 'ë°°ë‹¬'],
                'êµí†µ': ['íƒì‹œ', 'ë²„ìŠ¤', 'ì§€í•˜ì² ', 'ì£¼ìœ ', 'í•˜ì´íŒ¨ìŠ¤', 'ì˜ì¹´', 'ê¸°ì°¨', 'ì½”ë ˆì¼', 'Tmoney'],
                'ì‡¼í•‘': ['ì¿ íŒ¡', 'ë„¤ì´ë²„í˜ì´', 'ë‹¤ì´ì†Œ', 'ì˜¬ë¦¬ë¸Œì˜', 'ë°±í™”ì ', 'ëª°', 'Store'],
                'ë¬¸í™”/ì—¬ê°€': ['CGV', 'ë¡¯ë°ì‹œë„¤ë§ˆ', 'ë„·í”Œë¦­ìŠ¤', 'ìœ íŠœë¸Œ', 'í‹°ë¹™', 'ë©œë¡ ', 'ë³¼ë§'],
                'ì£¼ê±°/í†µì‹ ': ['ê´€ë¦¬ë¹„', 'ì›”ì„¸', 'KT', 'SKT', 'LG', 'ê°€ìŠ¤', 'ì „ë ¥'],
                'ê¸ˆìœµ/ë³´í—˜': ['ë³´í—˜', 'ì´ì', 'ì¶œê¸ˆ', 'ì €ì¶•']
            };

            const newItems = [];

            rawData.forEach((row, index) => {
                // Skip basic header row (index 0 usually, or simple check)
                if (index === 0) return; // naive skip

                const rawAmount = row[amtIdx];
                const rawDesc = row[descIdx];

                // Parse Amount (handle strings like "10,000")
                let amount = 0;
                if (typeof rawAmount === 'number') amount = rawAmount;
                else if (typeof rawAmount === 'string') amount = parseInt(rawAmount.replace(/,/g, ''));

                if (amount > 0 && rawDesc) {
                    let category = 'ê¸°íƒ€';
                    for (const [cat, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
                        if (keywords.some(k => rawDesc.includes(k))) {
                            category = cat;
                            break;
                        }
                    }
                    newItems.push({ description: rawDesc, amount: amount, category: category });
                }
            });

            processedData = newItems;
            localStorage.setItem('budgetData', JSON.stringify(processedData));

            modal.classList.remove('open');
            showDashboard();
        }

        // --- Dashboard & Visualization ---

        function showDashboard() {
            uploadSection.classList.remove('active');
            setTimeout(() => {
                uploadSection.style.display = 'none';
                dashboardSection.classList.add('active');
                renderDashboard();
            }, 500);
        }

        function renderDashboard() {
            // Calc Totals
            const total = processedData.reduce((sum, item) => sum + item.amount, 0);
            const byCategory = {};
            processedData.forEach(item => {
                byCategory[item.category] = (byCategory[item.category] || 0) + item.amount;
            });

            // 1. CountUp Animation for Total
            animateValue("total-spend-display", 0, total, 2000);

            // 2. Insight
            const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
            const top = sorted[0];
            const insightHTML = `
                ê°€ì¥ í° ì§€ì¶œì€ <strong style="color:var(--secondary)">${top[0]}</strong>ì´ë©°, 
                ì „ì²´ì˜ ${(top[1] / total * 100).toFixed(1)}%ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤.<br>
                ${top[0]} ì§€ì¶œì„ ì¡°ê¸ˆë§Œ ì¤„ì—¬ë³´ë©´ ì–´ë–¨ê¹Œìš”?
            `;
            document.getElementById('insight-text').innerHTML = insightHTML;

            // 3. Chart
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(i => i[0]),
                    datasets: [{
                        label: 'ì§€ì¶œ ê¸ˆì•¡',
                        data: sorted.map(i => i[1]),
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(148, 163, 184, 0.8)'
                        ],
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 14 },
                            displayColors: false,
                            callbacks: {
                                label: function (context) {
                                    return context.parsed.y.toLocaleString() + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // --- Utils ---
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = Math.floor(progress * (end - start) + start);
                obj.innerHTML = current.toLocaleString() + '<span style="font-size:1.2rem">ì›</span>';
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

    </script>
</body>

</html>